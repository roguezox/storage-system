version: '3.8'

services:
  mongodb:
    image: mongo:7
    container_name: opendrive-db-repro
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: drive
    volumes:
      - mongodb_data_repro:/data/db
    ports:
      - "27018:27017" # Changed port to avoid conflict

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: opendrive-api-repro
    restart: unless-stopped
    depends_on:
      - mongodb
    environment:
      NODE_ENV: production
      PORT: 5000
      MONGODB_URI: mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@mongodb:27017/drive?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-local}
      STORAGE_PATH: /app/uploads
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_REGION: ${S3_REGION:-}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-}
    volumes:
      - uploads_data_repro:/app/uploads
    ports:
      - "5001:5000" # Changed port to avoid conflict

  frontend:
    image: ${DOCKERHUB_USERNAME}/opendrive-frontend:latest
    container_name: opendrive-web-repro
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "3002:3000" # Changed port to avoid conflict

volumes:
  mongodb_data_repro:
  uploads_data_repro:
